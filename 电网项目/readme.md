# 电网项目
**为什么做**:
- (因为部分涉密且签署保密协议, **以下笔者仅能透露脱敏信息**)
- (因为整体这是老板的项目, 但他给不出建设性建议)
- 上层任务需要符合实际**拓扑性质**与**地理性质**的**美国电网** (需要地理性质因为要与其他非电网模块**联调**).
- 实际的电网信息高度敏感且往往仅关心**拓扑性质**. 无法获取真实的电网数据 (更别论是美国的), 学术界仅开源**极少数基于算法合成的电网** (算法实现闭源), 同样只考虑拓扑.


**做了什么**
- 基于**脱敏公开的地理信息**构建合成电网的**元数据**.
- 实现算法, 让我们**合成**的电网在拓扑性质上, 符合实际电网统计出的一系列**图论性质** (即电网作为图论意义上的图, 应当符合的一系列性质).
- **合成**的电网哪怕符合一系列**拓扑性质**也未必可行, 因为它还需要满足一系列**电气性质**.「不可行」简单定义为执行某种预期会收敛的计算最终失败, 而这种「计算」往往依赖特定的执行环境 (具体的, Matlab). 我们让client在docker容器中执行**验证**工作.
- server的**合成**相当缓慢 (与client的**验证**相比). 为缓解此问题, 我们进入消息队列, 允许多个servers同时**合成**, 基于地理区域创造分区 (partition).
- client与server之间开始连接需要认证. 对于进行过「验证」的电网, client向server返回报文, server侧进行bookkeeping (这个电网能不能用? 不可行的可以直接删了)
- 天气对电网 (故障发生的概率) 有重要影响 (主要是气温, 风力), 且一张电网只表示其在特定天气切面下的状态. 我们从IEEE的现行标准出发, 实现了对同一张电网, 从当前的<气温, 风力>迁移到目的<气温, 风力>的**仿射变换**.


**最终效果**
每日为上游任务提供约 $1000$ 张高质量的小规模电网 (节点数 $n \leq 1000$).

Q: 电网需要「拓扑信息」是比较显然的, 为什么还需要「地理信息」? 不带地理信息的电网是什么样的?
>A: 学术界能用的典型电网 (不带地理信息的) 是这样的 (ieee 9 bus测试案例), 在节点与传输线构成的无向图之外, 还附带一系列电气参数:
![](./images/ieee9bus_1.bmp)
![](./images/ieee9bus_2.bmp)
再比如少数像ieee 39 bus测试案例这样的, 描述了对应的地理位置区域 (新英格兰地区), 但只有非常少的测试样例像这样给出了每个节点的**地理位置**, 而且ieee的测试样例绝大多数规模小 (节点数 $n<200$) 且无关地理信息.
![](./images/ieee39bus_1.bmp)
![](./images/ieee39bus_2.bmp)

除了ieee测试案例外, 存在合成电网的工作, 这部分工作仅开源少量数据而未开源算法 (**像这样用地图描述的仅存在于demo, 实际数据无法获得**), 而公开的数据**难以对拓扑结构进行改造调整** (少量的改动就会对电力的调动造成重大的影响, 稍微可行的是调整电气参数)
![](./images/ACTIVSg2000.bmp)

Q: OK, pipeline中元数据有哪些?
> A: 最重要的元数据是[美国人口普查](./uszips.csv) (本项目使用2014版, 一个[在线链接](https://beta.sedac.ciesin.columbia.edu/data/set/gpw-v4-population-count)), 普查以zip邮政编码为主键逐行维护一些信息. 最重要的信息包括**zip码, 经纬度, 人口数, 所属州**. 人口数直接关连节点的用电量; 所属州给出了合成电网的物理边界.
如下午笔者将南卡罗莱纳州的所有zip点画在地图上:
![](./images/初始人口普查zips.png)
我们的方案就是从这些原始点出发, 通过参数控制聚类可以合成**规模不同, 但描述的地理区域相同**的类似的电网.

> 除此以外, 所有装机量 (可以理解为全力开动时的最大功率)$\geq 1MW$的发电站都能获得. 一个[在线](https://atlas.eia.gov/datasets/eia::power-plants/explore)网站可以可视化地获得对应数据, 如下图, 同时数据可下载为`.csv`文件.
![](./images/atlas_online.png)
我们将所有电厂的位置也显示在同一片地图上. **zips+电厂**构成了所有的(与地理人口相关的)元数据 (蓝色的点是电厂).
![](./images/zips和电厂.png)

Q: 这个点有点多啊. 你有什么处理的pipeline吗?
> A: 为了实现同一片地理区域, 不同"分辨率"的效果, pipeline中比较早的阶段进行了对点的**聚类**. 另一方面为了限制不同点的距离不至于太近.对于zip点, 我们用**人口数**表征点的权重. 假设原始的两个zip点$A, B$, 各自的经纬度为$Lon, Lat$, 人口为$Popu$, 则合成后的点的经纬度为:
$$\frac{Popu_{a}}{Popu_{a}+Popu_{b}}.\begin{bmatrix}Lon_{a} \\Lat_{a}\end{bmatrix}+\frac{Popu_{b}}{Popu_{a}+Popu_{b}}.\begin{bmatrix}Lon_{b} \\Lat_{b}\end{bmatrix}$$
需要注意的是, 对合成出来的**等价zip点**, 它们非常可能参与新的合成. 因此实际流程中, 每个合成出的等价zip点都会维护完整的**初始zip点集合** (这是一个并查集的例子.). 假设我们要合成两个等价zip点 $X,Y$各自对应了初始点集 $\{\alpha_{1}\cdots\alpha_{n}\}, \{\beta_{1}\cdots\beta_{m}\}$, 现在的合成使用 $n+m$个初始zip点 (它们是不交的), 各自权重形如 $\frac{\alpha_{t}}{\sum_{i=0}^{n}\alpha_{i}+\sum_{i=0}^{m}\beta_{i}}$.

> **开发过程中还实际发现了一个bug**: 如果$Popu_{a}$和$Popu_{b}$都为0了怎么办? 在处理德州这样比较"地广人稀"的区域发现了这个情况: 这会在距离zip点A最近的邻居是zip点B, **两者人口都是0而算法现在打算聚合它们时**触发这个边界情况 (golang不会panic, 但会认为计算出的是NAN让后续计算出错.). 应对这种情况, 笔者让每个zip**至少拥有1人口**.
算法的聚合会计算计算任意结点对之间的**距离**, 事实上因为元数据是只读的, 我们预先计算了每个点在领域 $\epsilon < 100km$ 以内的邻居集合存储在数据库 (同样是只读逻辑), 因此我们载入所有这样的**邻居对**, 使用优先级队列维护聚合的过程.
具体来说我们在golang需要实现一系列接口 (针对自定义数据类型)
```Golang
type origin_zip struct {
	Coord    haversine.Coord
	Popu     float64 // ????
	Zip_code uint
}

type clustered_zip struct {
	Origin_zips []origin_zip
	Eq_lat      float64
	Eq_lng      float64
	Total_popu  float64
}

type clustered_pair struct {
	cluster_A *clustered_zip
	cluster_B *clustered_zip
}

type clustered_pair_heap []clustered_pair

func (h clustered_pair_heap) Len() int {
	return len(h)
}

func (h clustered_pair_heap) Swap(i, j int) {
	h[i], h[j] = h[j], h[i]
}

func (h *clustered_pair_heap) Push(x interface{}) {
	*h = append(*h, x.(clustered_pair))
}

func (h *clustered_pair_heap) Pop() interface{} {
	old := *h
	n := len(old)
	item := old[n-1]
	*h = old[0 : n-1]
	return item
}
// 以及Less接口.
func (h clustered_pair_heap) Less(i, j int) bool {
    // 计算元素i和元素j的"特征值".
    // i成员是个pair: `cluster_A`, `cluster_B`, 假设分别有n和m个初始元素
    // 计算加权平均距离 (权就是上面的人口). 距离更短的Less在前.
}
```
笔者使用一个参数控制聚合后点数控制结束.

> 上面描述的是对zip点的聚合, 对电厂节点的聚合类似, 但略有不同. 首先对电厂而言使用**装机量**作为权重. 其次考虑到不同能源性质的电厂在架构上相当不同, 且电厂元数据有字段`PrimSource`表征主能源性质 (如`petroleum`, `natural gas`, `hydroelectric`, `nuclear`). 笔者这里特判限制, 对于特定能源 (典型如`nuclear`, `hydroelectric`) 聚合的两端所有电厂只有**能源性质一致**, 才能聚合.

Q: 聚类中**权重**是一个要素, **距离**的度量方法也很重要. 这里距离是怎么量度的, 它反复出现?
> A: 给定地球上两个点的经纬度, 我们使用常规的haversine距离度量, 参见[wiki主页](https://en.wikipedia.org/wiki/Haversine_formula). 在不考虑**海拔差异, 地球作为球体的不规则性等更现实情况时**, 此公式衡量两点的测地线距离是完美的. 本项目量度大量使用该距离.
![](./images/haversine_demo.png)

Q: OK, 对于节点还有什么约束吗?
> A: 上面提到了zip合成用电节点 (即PQ节点), 电厂节点合成供电节点 (即PV节点). 但现实中它们不是一个二分类问题, 即在所有有用电需求的节点中, 存在一定数目 (一般为 $5\sim10\%$) 的节点同时自身会**供电**, 虽然它们**未必自给自足**, 可能依然需要外界一定程度地输电, 或者本节点有余力向外输送部分.
![](./images/load_gen_dist.png)
为此, 我们从全体聚合后的PQ节点中, **随机抽样**部分节点作为**能自身供电的节点**. 同时同现有文献出发 (如上图所示), "自给自足"的比率一般在 $(\frac{1}{e}, e)$ 之间, 我们在这个区间生成均匀分布的随机数$x$, 含义为假设PQ节点$A$需要 $M W$的有功功率, 那么本地能发电 $Mx W$ 的功率. 我们按照剩余PV节点离$A$的距离从近到远候选, 依次聚合到节点 $A$, 被聚合的PV节点被移除.

Q: ok, 现在能描述下**电网作为图论意义上的图, 它有哪些特殊之处吗**? 生成的时候有什么考虑?

> A: 电网作为图的性质, 非常大的程度上决定了我们下面 "连边" (传输线) 的过程. 具体来说作为图的性质有下列:
- **稀疏性**: 一般意义上, 我们认为一个图边的数目 $m$ 不超过 $nlogn$ 即为**稀疏图**, 其中$n$为图节点的数目. 而现实数据分析电网中$m\approx1.2\sim1.3n$.
- **节点度数的指数分布**: 现有的文章有分析, 与社交媒体网络等度数趋向于幂律分布不同, 电网因为相比之下缺少无可争议的中心节点导致不会出现度数很大的节点 (e.g., 度数$>10$), 且在度数 $>3$后呈现指数分布, 而度数为1的叶子节点和度数为为2的节点需要单独考虑校验. 这部分信息笔者follow[文章](https://ieeexplore.ieee.org/document/7515182).
- **传输线总长较短**: 很好理解, 因为传输线路的长度和建设成本直接挂钩. 如果从最小生成树出发, 全局成本得以最小化, 但是:
- **较短的随机跳数**: 电网因为线路的假设是逐步进行的, 很难在一开始就以最小生成树来规划. **而且**仅仅是最小生成树的话电网一点也不够健壮, 因为任意两点之间的条数太长了且固定, 这将导致**无功功率**难以长距离输送: 传输线发热量少, 有功功率的损耗一般远小于 $5\%$, 但对无功功率的消耗就大很多 (无功功率可以理解为"泵"). 电网图的"平均跳数"约为$\sqrt{n}$, 在规划总长度较短时需要考虑平均跳数.
- **较小的团系数**: 在联通图的基础上, 我们添加一些冗余的边. 电网倾向于让这些冗余的边别构成一个完全图, 即直观上来说电网不喜欢边"抱团".
考虑一个完全图, 它的团系数为1. 设电网有一个点$A$, 它的全体邻居为 $B, C, D, E4$ 个点. $4$个点最差构成完全图共$6$条边, 但实际这$4$个点两两连出 $x\in\{0, 1, 2, 3, 4, 5, 6\}$个边, 于是点$A$对应的团系数为$\frac{x}{6}$. 我们计算整个电网的平均团系数 (所有点权重相同) $\beta$, 一般地它会很小 ($< 0.1$).
- **平面图倾向**: 如下图所示的是**平面图**: 将一些边拉伸后, 边与边只在节点有交.
![](./images/planar_graph.png)
但与此同时, 有相当数量的图在不改变拓扑的情况下无论怎么对边拉伸, 它依然不可能是平面图, 比如下图的Peterson图.
![](./images/peterson_graph.png)
电网中只有较少的边与其他边在非节点 (PV, PQ节点) 处相交. 但同时, 电网的传输线一般都是直的 (比如沿着长距离公路排布), 以节省建设成本.

Q: 这么一大坨性质, 你打算怎么着手开始连边?
> A: 之前有一些研究考虑了delaunay三角剖分, 它是一种特殊的三角剖分, 与最小生成树有着有趣的关系. 像下图(a)就不是delaunay三角剖分, 因为存在点$d$, 在$a, b, c$三点构成的外接圆内. **delaunay三角剖分**要求剖分出的任意三角形, 其外接圆内无其他点, 除了弧上的此三点. 可以证明给定点集, delaunay三角剖分**必定存在** (但不一定唯一, 对同样的图我用不同的三方库就剖出来不一样). delaunay三角剖分的一个性质为: **给定同样的完全图, 最小生成树的边集, 是delaunay三角剖分边集的子集**! 更多信息见[slide, 有对应关于MST的条目](https://www.cs.umd.edu/class/fall2021/cmsc754/Lects/lect11-delaun-prop.pdf).
![](./images/delaunay_tri.png)

> 三角剖分后的边集部分如下, 其中红实线为MST边集, 黑虚线为delaunay三角剖分边集 (剔除MST边集), 黄虚线为delaunay三角剖分"一阶邻近边集" (这个中文是笔者杜撰的, 可以理解为delaunay三角剖分生成了一个表示联通性的0/1矩阵$M$, 如果$M[i][j]=0但M^{2}[i][j]=1$, 则$<i, j>$是一阶临近关系.)
![](./images/部分候选边集.png)
我们从三角剖分边集中选边, 有一个好处: 原本完全图的$n*(n/2)$边数空间, 现在下降到$3*n$, 即初始的delaunay三角剖分给出 $3*n$ 的边数目, 而通常电网的$n\in[100, 10000]$. 考虑到拓展为三阶临近关系, 边数也不会超过 $27*n$.
**因此笔者的算法宏观来说, 设定总的边数 ($1.21n$), 给定每一类边配额 (MST边, 一/二/三阶临近边), 不断地擦除, 添加, 直到收敛到上述条件**.